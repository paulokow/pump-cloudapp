<html>
    <head>
        <!-- Latest compiled and minified CSS --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
        <!-- jQuery library --><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <!-- Latest compiled JavaScript --><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>  
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        {% if measures %}
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.load('current', {'packages':['table']});
      google.charts.setOnLoadCallback(drawChart);

      function roundMinutes(date) {
//         date.setHours(date.getHours() + Math.round(date.getMinutes()/60));
//         date.setMinutes(0);
         date.setSeconds(0);
         date.setMilliseconds(0);
         return date;
      }

      function drawChart() {
         var databg = new google.visualization.DataTable();
         databg.addColumn('datetime', 'Date & Time');
         databg.addColumn('number', 'BG Value');
         {% for m in measures %}
           databg.addRow([roundMinutes(new Date("{{ m.timestamp.isoformat }}")), {{ m.value }}]);
         {% endfor %}
         var databolus = new google.visualization.DataTable();
         databolus.addColumn('datetime', 'Date & Time');
         databolus.addColumn('number', 'Bolus');
         {% for m in boluses %}
           databolus.addRow([roundMinutes(new Date("{{ m.timestamp.isoformat }}")), {{ m.delivered }}]);
         {% endfor %}
         
         var datalimits = new google.visualization.DataTable();
         datalimits.addColumn('datetime', 'Date & Time');
         datalimits.addColumn('number', 'BG Low');
         datalimits.addColumn('number', 'BG High');
         datalimits.addRow([roundMinutes(new Date("{{ mintime.isoformat }}")), 70, 140]);
         datalimits.addRow([roundMinutes(new Date("{{ maxtime.isoformat }}")), 70, 140]);
         
         var datawiz = new google.visualization.DataTable();
         datawiz.addColumn('datetime', 'Date & Time');
         datawiz.addColumn('number', 'Meal (KE)');
         {% for m in wizardvalues %}
           datawiz.addRow([roundMinutes(new Date("{{ m.timestamp.isoformat }}")), {{ m.carbInput }}]);
         {% endfor %}
         
         var data = google.visualization.data.join(databg, datawiz, 'full', [[0, 0]], [1], [1]);
         var data = google.visualization.data.join(data, databolus, 'full', [[0, 0]], [1,2], [1]);
         var datafull = google.visualization.data.join(data, datalimits, 'full', [[0, 0]], [1,2,3], [1,2]);

   function floorDate(datetime) {
     var newDate = new Date(datetime);
//     newDate.setHours(0);
     newDate.setMinutes(0);
     newDate.setSeconds(0);
     return newDate;
   }
   
   function avgNotNulls(arr) {
     var cnt = 0;
     var sum = 0;
     for (var i = 0; i < arr.length; i++) {
       if (arr[i] != null)
       {
         cnt++;
         sum += arr[i];
       }
     }
     return cnt > 0 ? sum / cnt : null;
   }

   function sumNotNull(arr) {
     var cnt = 0;
     var sum = 0;
     for (var i = 0; i < arr.length; i++) {
       if (arr[i] != null)
       {
         cnt++;
         sum += arr[i];
       }
     }
     return cnt > 0 ? sum : null;   
   }

   var newData = google.visualization.data.group(data, [{
        column: 0,
        modifier: floorDate,
        type: 'datetime'
    }], [{
        column: 1,
        label: 'BG',
        aggregation: avgNotNulls,
        type: 'number'
    }, {
        column: 2,
        label: 'KE',
        aggregation: sumNotNull,
        type: 'number'
    }, {
        column: 3,
        label: 'Bolus',
        aggregation: sumNotNull,
        type: 'number'
    }]);

         var newData = google.visualization.data.join(newData, datalimits, 'full', [[0, 0]], [1,2,3], [1,2]);
         
         var options = {
          title: 'BG Values',
          curveType: 'function',
          interpolateNulls: true,
          height: 450,
          width: 600,
          bar: {
            groupWidth: 20,
          },
          colors: ['#3366cc', '#109618', '#990099', '#dc3912', '#ff9900'],
          series: {
            0: { pointSize: 5, targetAxisIndex: 0 },
            1: { pointSize: 4, pointShape: 'square', targetAxisIndex: 1, interpolateNulls: false, type: 'bars' },
            2: { pointSize: 4, pointShape: 'diamond', targetAxisIndex: 1, interpolateNulls: false, type: 'bars' },            
            3: { targetAxisIndex: 0 },
            4: { targetAxisIndex: 0 },
          },
          legend: { position: 'bottom' },
          hAxis: {
            format: "d/M H:mm",
            slantedText:true, 
            slantedTextAngle:75
          },
          vAxes: {
            0: {
              ticks: [0, 50, 70, 100, 140, 200, 250, 300, 350, 400]
            },
            1: {
              gridlines: {color: 'transparent'},
              ticks: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
            }
          }
        };

        var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
        var chart2 = new google.visualization.LineChart(document.getElementById('curve_chart2'));
	var table = new google.visualization.Table(document.getElementById('table_div'));
	var table2 = new google.visualization.Table(document.getElementById('table_div2'));

        chart.draw(datafull, options);
	table.draw(data, {width: 600,});
        chart2.draw(newData, options);
	table2.draw(newData, {width: 600,});
      }
    </script>
       {% endif %}
    </head>
    <body>
       <section id="main">
        <div class="container">
          <div id="curve_chart" class="col-md-6"></div>
          <div id="table_div" class="col-md-6"></div>
        </div>
        <div class="container">        
          <div id="curve_chart2" class="col-md-6"></div>
          <div id="table_div2" class="col-md-6"></div>
        </div>
       </section>
    </body>
</html>

